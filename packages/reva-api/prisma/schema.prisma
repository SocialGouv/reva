generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CertificationStatus {
  INACTIVE
  SOON
  AVAILABLE
}

enum ExperienceDuration {
  unknown
  lessThanOneYear
  betweenOneAndThreeYears
  moreThanThreeYears
  moreThanFiveYears
  moreThanTenYears
}

model Certification {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  label       String    @db.VarChar(255)
  acronym     String    @db.VarChar(255)
  level       Int       
  activities  String?
  activityArea      String? @map("activity_area")
  accessibleJobType String? @map("accessible_job_type")
  abilities   String?
  slug        String
  summary String?
  status      CertificationStatus @default(INACTIVE)
  rncpId      String    @unique @map("rncp_id") @db.VarChar(255)
  romes       RomesOnCertifications[]
  // candidacies Candidacy[]
  candidaciesAndRegions CandidaciesOnRegionsAndCertifications[]
  organismsAndRegions OrganismsOnRegionsAndCertifications[]
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  @@map("certification")
}

model Profession {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  label       String    @db.VarChar(255)
  slug        String
  description String?
  romeId      String    @db.Uuid @map("rome_id")
  rome Rome? @relation(fields: [romeId], references: [id])

  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  @@map("profession")
}

model Rome {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  code        String    @unique @db.VarChar(255)
  label       String    @db.VarChar(255)
  slug        String    @db.VarChar(255)
  url         String    @db.VarChar(255)
  profession  Profession[]
  certifications RomesOnCertifications[]
  isActive    Boolean   @default(false) @map("is_active")
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  @@map("rome")
}


model RomesOnCertifications {
  certification       Certification @relation(fields: [certificationId], references: [id])
  certificationId     String        @db.Uuid  @map("certification_id")
  rome                Rome          @relation(fields: [romeId], references: [id])
  romeId              String        @db.Uuid  @map("rome_id")
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  @@id([certificationId, romeId])
  @@map("rome_certification")
}


model Candidacy {
  id        String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  deviceId  String    @db.VarChar(255)
  organism       Organism? @relation(fields: [organismId], references: [id])
  organismId     String?        @db.Uuid  @map("organism_id")
  candidacyStatuses CandidaciesStatus[]
  goals CandicadiesOnGoals[]
  experiences Experience[]
  certificationsAndRegions CandidaciesOnRegionsAndCertifications[]
  typology CandidateTypology  @default(NON_SPECIFIE)
  typologyAdditional String? @map("typology_additional")
  firstAppointmentOccuredAt   DateTime?  @db.Timestamptz(6) @map("first_appointment_occured_at")
  wasPresentAtFirstAppointment Boolean? @map("was_present_at_first_appointment")
  appointmentCount Int @default(0) @map("appointment_count")
  phone   String?  @db.VarChar(255)
  email   String?  @db.VarChar(255)
  trainings TrainingOnCandidacies[]
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("candidacy")
}


/// Candicadies statuses
model CandidaciesStatus {
  id        String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  candidacy       Candidacy @relation(fields: [candidacyId], references: [id], onDelete: Cascade)
  candidacyId     String  @db.Uuid  @map("candidacy_id")
  status          CandidacyStatus @default(PROJET)
  isActive    Boolean   @default(false) @map("is_active")    
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("candidacy_candidacy_status")
}

enum CandidacyStatus {
  ARCHIVE
  PROJET
  VALIDATION
  PRISE_EN_CHARGE
  DOSSIER_PRO
  CERTIFICATION
}

model Goal {
  id        String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  label      String   @unique @db.VarChar(255)
  needsAdditionalInformation Boolean @default(false) @map("needs_additional_information")
  isActive    Boolean   @default(false) @map("is_active")
  candidacies CandicadiesOnGoals[]
  order       Int
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("goal")
}

model CandicadiesOnGoals {
  candidacy       Candidacy @relation(fields: [candidacyId], references: [id], onDelete: Cascade)
  candidacyId     String        @db.Uuid  @map("candidacy_id")
  goal                Goal          @relation(fields: [goalId], references: [id])
  goalId              String        @db.Uuid  @map("goal_id")
  additionalInformation    String?    @map("additional_information")
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  @@id([candidacyId, goalId])
  @@map("candidacy_goal")
}

model Experience {
  id        String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  title String
  description String
  duration    ExperienceDuration
  startedAt   DateTime
  candidacy       Candidacy @relation(fields: [candidacyId], references: [id], onDelete: Cascade)
  candidacyId     String        @db.Uuid  @map("candidacy_id")
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("experience")
}

enum CandidateTypology {
  NON_SPECIFIE
  SALARIE_PRIVE
  SALARIE_PUBLIC_HOSPITALIER
  DEMANDEUR_EMPLOI
  AIDANTS_FAMILIAUX
  AUTRE
}

model Region {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  label       String   @unique @db.VarChar(255)
  code        String    @unique @db.VarChar(3)
  candidaciesAndCertifications CandidaciesOnRegionsAndCertifications[]
  organismsAndCertifications OrganismsOnRegionsAndCertifications[]
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("region")
}

model CandidaciesOnRegionsAndCertifications {
  id        String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  candidacy       Candidacy @relation(fields: [candidacyId], references: [id], onDelete: Cascade)
  candidacyId     String        @db.Uuid  @map("candidacy_id")
  region                Region          @relation(fields: [regionId], references: [id])
  regionId              String        @db.Uuid  @map("region_id")
  certification                Certification          @relation(fields: [certificationId], references: [id])
  certificationId              String        @db.Uuid  @map("certification_id")
  isActive    Boolean   @default(false) @map("is_active")
  author      String    @db.VarChar(255)
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  // @@unique([candidacyId, regionId, certificationId])
  @@map("candidacy_region_certification")
}

model Account {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  email String @db.VarChar(255) @unique
  firstname String? @db.VarChar(255)
  lastname String? @db.VarChar(255)
  organism Organism?  @relation(fields: [organismId], references: [id])
  organismId     String?   @db.Uuid  @map("organism_id")
  keycloakId String @db.Uuid @unique  @map("keycloak_id") 
  @@map("account")
}

model Organism {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()")) 
  label String  @unique @db.VarChar(255)
  address  String
  zip  String   @db.VarChar(5)
  city  String @db.VarChar(255)
  contactAdministrativeEmail String @unique @db.VarChar(255) @map("contact_administrative_email")
  contactCommercialName String @map("contact_commercial_name")
  contactCommercialEmail  String @map("contact_commercial_email")
  siret String
  isActive    Boolean   @default(false) @map("is_active")
  candidacies Candidacy[]
  accounts Account[]
  regionsAndCertifications OrganismsOnRegionsAndCertifications[]
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("organism")
}

model OrganismsOnRegionsAndCertifications {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()")) 
  organism       Organism @relation(fields: [organismId], references: [id], onDelete: Cascade)
  organismId     String        @db.Uuid  @map("organism_id")
  region                Region          @relation(fields: [regionId], references: [id])
  regionId              String        @db.Uuid  @map("region_id")
  isArchitect           Boolean @default(false) @map("is_architect")
  isCompanion           Boolean @default(false) @map("is_companion")
  certification                Certification          @relation(fields: [certificationId], references: [id])
  certificationId              String        @db.Uuid  @map("certification_id")
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@unique([organismId, regionId, certificationId])
  @@map("organism_region_certification")
}


model Training {
  id          String    @id @db.Uuid @default(dbgenerated("uuid_generate_v4()"))
  label        String    @unique @db.VarChar(255)
  candidacies TrainingOnCandidacies[]
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")
  @@map("training")
}

model TrainingOnCandidacies {
  training       Training @relation(fields: [trainingId], references: [id])
  trainingId     String        @db.Uuid  @map("training_id")
  candidacy      Candidacy          @relation(fields: [candidacyId], references: [id])
  candidacyId              String        @db.Uuid  @map("candidacy_id")
  createdAt   DateTime  @db.Timestamptz(6) @default(now()) @map("created_at")
  updatedAt   DateTime? @db.Timestamptz(6) @map("updated_at")

  @@id([trainingId, candidacyId])
  @@map("training_candidacy")
}
